<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="account_payment_report_view_search" model="ir.ui.view">
        <field name="name">account.payment.report.view.search</field>
        <field name="model">account.payment.report</field>
        <field name="arch" type="xml">
            <search string="">
                <field name="name" />
                <field name="user_id" />
                <field name="journal_id" />
                <filter name="draft" string="Borrador" domain="[('state', '=', 'draft')]" />
                <filter name="pending" string="Sin aprobar" domain="[('state', '=', 'pending')]" />
                <filter name="approved" string="Aprobado" domain="[('state', '=', 'approved')]" />
                <filter name="accounted" string="Pago contabilizado"
                    domain="[('state', '=', 'accounted')]" />
                <separator />
                <group expand="0" string="Agrupar por">
                    <filter name="user_id_group" string="Creado por" domain=""
                        context="{'group_by': 'user_id'}" />
                    <filter name="journal_id_group" string="Diario de pago" domain=""
                        context="{'group_by': 'journal_id'}" />
                </group>
            </search>
        </field>
    </record>
    <record id="account_payment_report_view_tree" model="ir.ui.view">
        <field name="name">account.payment.report.view.tree</field>
        <field name="model">account.payment.report</field>
        <field name="arch" type="xml">
            <tree string="Reportes de pagos masivos">
                <field name="name" />
                <field name="company_id" optional="hide" />
                <field name="user_id" />
                <field name="date_report" />
                <field name="activity_ids" string="Actividades" widget="list_activity" />
                <field name="state" decoration-success="state == 'accounted'"
                    decoration-warning="state == 'pending'" decoration-info="state == 'approved'"
                    decoration-danger="state == 'canceled'" widget="badge" />
            </tree>
        </field>
    </record>

    <record
        id="account_payment_report_view_form" model="ir.ui.view">
        <field name="name">account.payment.report.view.form</field>
        <field name="model">account.payment.report</field>
        <field name="arch" type="xml">
            <form string="Reporte de pagos masivos" duplicate="0">
                <header>
                    <button string="Solicitar aprobación" name="set_as_pending" type="object"
                        class="oe_highlight" attrs="{'invisible': [('state','!=','draft')]}"
                        groups="toh_mass_payment_report.group_mass_payment_user" />

                    <!-- Botones de APROBAR para los grupos de aprobación 1, 2, 3 y 4 -->
                    <button string="Primera aprobación" name="action_first_approval" type="object"
                        class="oe_highlight"
                        attrs="{'invisible': ['|', ('state','!=','pending'), '|', ('first_approval_in_this_company','=',False), '|', ('level_approval','!=','1'), ('lines_approved_group_approver_1','=',False)]}"
                        groups="toh_mass_payment_report.group_mass_payment_approver_1" />
                    <button string="Segunda aprobación" name="action_second_approval" type="object"
                        class="oe_highlight"
                        attrs="{'invisible': ['|', ('state','!=','pending'), '|', ('second_approval_in_this_company','=',False), '|', ('level_approval','!=','2'), ('lines_approved_group_approver_2','=',False)]}"
                        groups="toh_mass_payment_report.group_mass_payment_approver_2" />
                    <button string="Tercera aprobación" name="action_third_approval" type="object"
                        class="oe_highlight"
                        attrs="{'invisible': ['|', ('state','!=','pending'), '|', ('third_approval_in_this_company','=',False), '|', ('level_approval','!=','3'), ('lines_approved_group_approver_3','=',False)]}"
                        groups="toh_mass_payment_report.group_mass_payment_approver_3" />
                    <button string="Cuarta aprobación" name="set_as_approved" type="object"
                        class="oe_highlight"
                        attrs="{'invisible': ['|', ('state','!=','pending'), '|', ('fourth_approval_in_this_company','=',False), '|', ('level_approval','!=','4'), ('lines_approved_group_approver_4','=',False)]}"
                        groups="toh_mass_payment_report.group_mass_payment_approver_4" />
                    
                    <!-- Botón RESTABLECER para grupos de aprobación 1, 2, 3 y 4 -->
                    <button string="Enviar a revisión" name="set_as_draft" type="object"
                        attrs="{'invisible': ['|', ('state','!=','pending'), '|', ('lines_pending_group_1','=',True), '|', ('level_approval','!=','1'), ('first_approval_in_this_company','=',False)]}"
                        groups="toh_mass_payment_report.group_mass_payment_approver_1" />
                    <button string="Enviar a revisión" name="set_as_draft" type="object"
                        attrs="{'invisible': ['|', ('state','!=','pending'), '|', ('lines_pending_group_2','=',True), '|', ('level_approval','!=','2'), ('second_approval_in_this_company','=',False)]}"
                        groups="toh_mass_payment_report.group_mass_payment_approver_2" />
                    <button string="Enviar a revisión" name="set_as_draft" type="object"
                        attrs="{'invisible': ['|', ('state','!=','pending'), '|', ('lines_pending_group_3','=',True), '|', ('level_approval','!=','3'), ('third_approval_in_this_company','=',False)]}"
                        groups="toh_mass_payment_report.group_mass_payment_approver_3" />
                    <button string="Enviar a revisión" name="set_as_draft" type="object"
                        attrs="{'invisible': ['|', ('state','!=','pending'), '|', ('lines_pending_group_4','=',True), '|', ('level_approval','!=','4'), ('fourth_approval_in_this_company','=',False)]}"
                        groups="toh_mass_payment_report.group_mass_payment_approver_4" />

                    <!-- Botones de RECHAZAR para grupos de aprobación 1, 2, 3 y 4 -->
                    <button string="Rechazar" name="set_as_canceled" type="object"
                        attrs="{'invisible': ['|', ('state','!=','pending'), '|', ('first_approval_in_this_company','=',False), ('level_approval','!=','1')]}"
                        groups="toh_mass_payment_report.group_mass_payment_approver_1" />
                    <button string="Rechazar" name="set_as_canceled" type="object"
                        attrs="{'invisible': ['|', ('state','!=','pending'), '|', ('second_approval_in_this_company','=',False), ('level_approval','!=','2')]}"
                        groups="toh_mass_payment_report.group_mass_payment_approver_2" />
                    <button string="Rechazar" name="set_as_canceled" type="object"
                        attrs="{'invisible': ['|', ('state','!=','pending'), '|', ('third_approval_in_this_company','=',False), ('level_approval','!=','3')]}"
                        groups="toh_mass_payment_report.group_mass_payment_approver_3" />
                    <button string="Rechazar" name="set_as_canceled" type="object"
                        attrs="{'invisible': ['|', ('state','!=','pending'), '|', ('fourth_approval_in_this_company','=',False), ('level_approval','!=','4')]}"
                        groups="toh_mass_payment_report.group_mass_payment_approver_4" />

                    <button string="Generar Pago" name="create_payments" type="object"
                        class="oe_highlight" attrs="{'invisible': [('state','!=','approved')]}"
                        groups="toh_mass_payment_report.group_mass_payment_generator" />
                    <button string="Establecer como borrador" name="set_as_draft" type="object"
                        class="oe_highlight" attrs="{'invisible': [('state','!=','canceled')]}" />
                    <button string="Cancelar" name="set_as_canceled" type="object"
                        attrs="{'invisible': [('state','!=','draft')]}"
                        groups="toh_mass_payment_report.group_mass_payment_user" />

                    <field name="state" widget="statusbar"
                        statusbar_visible="draft,pending,approved,accounted"
                        options="{'clickable': 0}" />
                </header>
                <sheet>
                    <field name="available_payment_method_line_ids" invisible="1" />
                    <field name="first_approval_in_this_company" invisible="1" />
                    <field name="second_approval_in_this_company" invisible="1" />
                    <field name="third_approval_in_this_company" invisible="1" />
                    <field name="fourth_approval_in_this_company" invisible="1" />
                    <field name="lines_approved_group_approver_1" invisible="1" />
                    <field name="lines_approved_group_approver_2" invisible="1" />
                    <field name="lines_approved_group_approver_3" invisible="1" />
                    <field name="lines_approved_group_approver_4" invisible="1" />
                    <field name="lines_pending_group_1" invisible="1" />
                    <field name="lines_pending_group_2" invisible="1" />
                    <field name="lines_pending_group_3" invisible="1" />
                    <field name="lines_pending_group_4" invisible="1" />

                    <div class="oe_title">
                        <label for="name" />
                        <h1 class="d-flex">
                            <field name="name" />
                        </h1>
                    </div>
                    <group>
                        <group attrs="{'readonly': [('state','!=','draft')]}">
                            <field name="journal_id" attrs="{'readonly': [('state','!=','draft')]}" />
                            <field name="payment_method_line_id" options="{'no_create': True}"
                                attrs="{'readonly': [('state','!=','draft')]}" />
                            <field name="l10n_mx_edi_payment_method_id"
                                attrs="{'readonly': [('state','!=','draft')]}" />
                        </group>
                        <group>
                            <field name="company_id" options="{'no_open': True}" />
                            <field name="approval_requested_by"
                                attrs="{'invisible': [('state','=','draft')]}" />
                            <field name="request_date"
                                attrs="{'invisible': [('state','=','draft')]}" />
                            <field name="level_approval" attrs="{'invisible': [('state','!=','pending')]}" />
                        </group>
                    </group>
                    <notebook>
                        <page name="trasaction_lines" string="Transacciones">
                            <field name="transaction_line_ids"
                                attrs="{'readonly': [('state','!=','draft')]}">
                                <tree>
                                    <field name="sequence" widget="handle" />
                                    <field name="record_reference" />
                                    <button icon="fa-external-link" title="Abrir transacción"
                                        name="action_open_record" type="object"
                                        attrs="{'invisible': [('type','=','tax')]}" />
                                    <field name="type" />
                                    <field name="pay_to" />
                                    <field name="currency_id" optional="show" />
                                    <field name="amount_total" />
                                    <field name="amount" />
                                    <field name="amount_residual" />
                                    <field name="payment_id" optional="hide" />
                                    <field name="state_approval" string="Estado"
                                        decoration-info="state_approval == 'paid'"
                                        decoration-success="state_approval == 'approved'"
                                        decoration-danger="state_approval == 'denied'" />

                                    <field name="approver_one_state" string="Aprobación 1" invisible="1" />
                                    <field name="approver_two_state" string="Aprobación 2" invisible="1" />
                                    <field name="approver_three_state" string="Aprobación 3" invisible="1" />
                                    <field name="approver_four_state" string="Aprobación 4" invisible="1" />
                                    <field name="state_report" invisible="1" />
                                    <field name="level_approval" invisible="1" />
                                    <field name="first_approval_in_this_company" invisible="1" />
                                    <field name="second_approval_in_this_company" invisible="1" />
                                    <field name="third_approval_in_this_company" invisible="1" />
                                    <field name="fourth_approval_in_this_company" invisible="1" />

                                    <!-- Botones aprovar / rechazar para grupo APROBADOR 1 -->
                                    <button icon="fa-check" string="" title="Aprobar"
                                        name="action_approve_transaction_line" type="object"
                                        class="btn-success btn-sm"
                                        context="{'group_approver': 1}"
                                        attrs="{'invisible': ['|',('first_approval_in_this_company','=',False), '|', ('level_approval','!=','1'), ('approver_one_state','!=','pending')]}" />
                                    <button icon="fa-times" string="" title="Rechazar"
                                        name="action_deny_transaction_line" type="object"
                                        class="btn-danger btn-sm"
                                        context="{'group_approver': 1}"
                                        attrs="{'invisible': ['|',('first_approval_in_this_company','=',False), '|', ('level_approval','!=','1'), ('approver_one_state','!=','pending')]}" />

                                    <!-- Botones aprovar / rechazar para grupo APROBADOR 2 -->
                                    <button icon="fa-check" string="" title="Aprobar"
                                        name="action_approve_transaction_line" type="object"
                                        class="btn-success btn-sm"
                                        context="{'group_approver': 2}"
                                        attrs="{'invisible': ['|',('second_approval_in_this_company','=',False), '|', ('level_approval','!=','2'), ('approver_two_state','!=','pending')]}" />
                                    <button icon="fa-times" string="" title="Rechazar"
                                        name="action_deny_transaction_line" type="object"
                                        class="btn-danger btn-sm"
                                        context="{'group_approver': 2}"
                                        attrs="{'invisible': ['|',('second_approval_in_this_company','=',False), '|', ('level_approval','!=','2'), ('approver_two_state','!=','pending')]}" />

                                    <!-- Botones aprovar / rechazar para grupo APROBADOR 3 -->
                                    <button icon="fa-check" string="" title="Aprobar"
                                        name="action_approve_transaction_line" type="object"
                                        class="btn-success btn-sm"
                                        context="{'group_approver': 3}"
                                        attrs="{'invisible': ['|',('third_approval_in_this_company','=',False), '|', ('level_approval','!=','3'), ('approver_three_state','!=','pending')]}" />
                                    <button icon="fa-times" string="" title="Rechazar"
                                        name="action_deny_transaction_line" type="object"
                                        class="btn-danger btn-sm"
                                        context="{'group_approver': 3}"
                                        attrs="{'invisible': ['|',('third_approval_in_this_company','=',False), '|', ('level_approval','!=','3'), ('approver_three_state','!=','pending')]}" />

                                    <!-- Botones aprovar / rechazar para grupo APROBADOR 4 -->
                                    <button icon="fa-check" string="" title="Aprobar"
                                        name="action_approve_transaction_line" type="object"
                                        class="btn-success btn-sm"
                                        context="{'group_approver': 4}"
                                        attrs="{'invisible': ['|',('fourth_approval_in_this_company','=',False), '|', ('level_approval','!=','4'), ('approver_four_state','!=','pending')]}" />
                                    <button icon="fa-times" string="" title="Rechazar"
                                        name="action_deny_transaction_line" type="object"
                                        class="btn-danger btn-sm"
                                        context="{'group_approver': 4}"
                                        attrs="{'invisible': ['|',('fourth_approval_in_this_company','=',False), '|', ('level_approval','!=','4'), ('approver_four_state','!=','pending')]}" />

                                    <button string="Ver pago"
                                        title="Abrir el pago generado relacionado"
                                        name="action_open_payment" class="oe_highlight"
                                        type="object"
                                        attrs="{'invisible': ['|',('payment_id','=',False),('state_report','!=','accounted')]}" />
                                </tree>
                                <form string="Línea de transacción">
                                    <group>
                                        <group>
                                            <field name="type"
                                                attrs="{'readonly': [('state_approval','=','approved')]}" />
                                            <field name="partner_id"
                                                attrs="{'invisible': [('type','in',['expense', False])], 'required': [('type','!=','expense')], 'readonly': [('state_approval','=','approved')]}" />
                                            <field name="invoice_id"
                                                attrs="{'invisible': [('type','!=','invoice')], 'required': [('type','=','invoice')], 'readonly': [('state_approval','=','approved')]}"
                                                options="{'no_quick_create': True, 'no_create': True}" />
                                            <field name="purchase_order_id"
                                                attrs="{'invisible': [('type','!=','purchase')], 'required': [('type','=','purchase')], 'readonly': [('state_approval','=','approved')]}"
                                                options="{'no_quick_create': True, 'no_create': True}" />
                                            <field name="expense_sheet_id"
                                                attrs="{'invisible': [('type','!=','expense')], 'required': [('type','=','expense')], 'readonly': [('state_approval','=','approved')]}"
                                                options="{'no_quick_create': True, 'no_create': True}" />
                                            <field name="tax"
                                                attrs="{'invisible': [('type','!=','tax')], 'required': [('type','=','tax')], 'readonly': [('state_approval','=','approved')]}" />
                                            <field name="employee_id"
                                                attrs="{'invisible': [('type','!=','expense')]}" />
                                        </group>
                                        <group>
                                            <field name="currency_id"
                                                attrs="{'invisible': [('type','!=','tax')], 'readonly': [('state_approval','=','approved')]}"
                                                options="{'no_create': True}" />
                                            <label for="amount_total" />
                                            <div name="amount_div" class="o_row">
                                                <field name="amount_total"
                                                    attrs="{'readonly': ['|', ('type','!=','tax'), ('state_approval','=','approved')]}" />
                                                <field name="currency" />
                                            </div>
                                            <label for="amount" />
                                            <div name="amount_div" class="o_row">
                                                <field name="amount"
                                                    attrs="{'readonly': [('state_approval','=','approved')]}" />
                                                <field name="currency" />
                                            </div>
                                            <label for="amount_residual" />
                                            <div name="amount_div" class="o_row">
                                                <field name="amount_residual" />
                                                <field name="currency" />
                                            </div>
                                        </group>
                                    </group>
                                    <group attrs="{'invisible': [('comment','=','')]}">
                                        <field name="approver_one_state" invisible="1" />
                                        <field name="state_approval" invisible="1" />
                                        <field name="comment" />
                                    </group>
                                </form>
                            </field>
                            <group name="comment_section">
                                <field name="note" placeholder="Agregar un comentario..."
                                    nolabel="0" />
                            </group>
                        </page>
                        <page name="extra_info" string="Información de aprobaciones">
                            <group>
                                <group name="first_approval" string="Primera aprobación">
                                    <field name="approved_first_by" />
                                    <field name="approved_date_first" />
                                    <field name="approver_one_sign" string="Firma"
                                        widget="signature"
                                        attrs="{'invisible': [('approved_first_by','=',False)]}" />
                                </group>
                                <group name="second_approval" string="Segunda aprobación">
                                    <field name="approved_second_by" />
                                    <field name="approved_date_second" />
                                    <field name="approver_two_sign" string="Firma"
                                        widget="signature"
                                        attrs="{'invisible': [('approved_second_by','=',False)]}" />
                                </group>
                                <group name="third_approval" string="Tercera aprobación">
                                    <field name="approved_third_by" />
                                    <field name="approved_date_third" />
                                    <field name="approver_three_sign" string="Firma"
                                        widget="signature"
                                        attrs="{'invisible': [('approved_third_by','=',False)]}" />
                                </group>
                                <group name="fourth_approval" string="Cuarta aprobación">
                                    <field name="approved_fourth_by" />
                                    <field name="approved_date_fourth" />
                                    <field name="approver_four_sign" string="Firma"
                                        widget="signature"
                                        attrs="{'invisible': [('approved_fourth_by','=',False)]}" />
                                </group>
                                <group name="payment_generator" string="Creador de pagos">
                                    <field name="paid_by" />
                                    <field name="payment_date" />
                                    <field name="paying_user_sign" string="Firma" widget="signature"
                                        attrs="{'invisible': [('paid_by','=',False)]}" />
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" groups="base.group_user" />
                    <field name="message_ids" />
                    <field name="activity_ids" />
                </div>
            </form>
        </field>
    </record>

    <record
        id="account_payment_report_action" model="ir.actions.act_window">
        <field name="name">Reporte de pagos masivos</field>
        <field name="res_model">account.payment.report</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Registrar un nuevo informe de pagos
            </p>
            <p>
                Un informe de pagos masivos permite realizar pagos a facturas de proveedores,
                órdenes de compra, reporte de gastos e impuestos, desde un mismo lugar.
            </p>
        </field>
    </record>

    <menuitem
        id="account_payment_report_menuitem"
        sequence="25"
        parent="account.menu_finance_payables"
        action="account_payment_report_action"
    />

</odoo>
